# Logger Go API - Архитектура приложения

Go REST API приложение для системы логирования, построенное по принципам Clean Architecture.

## Технологический стек

- **Go 1.25.1** - основной язык программирования
- **Gin** - веб-фреймворк для HTTP API
- **PostgreSQL** - база данных
- **Swagger** - документация API
- **Air** - hot reload для разработки
- **Docker** - контейнеризация

## Архитектура приложения

Приложение построено по принципам Clean Architecture с четким разделением на слои:

```
app/
├── cmd/app/                    # Точка входа приложения
│   └── main.go                 # Главный файл приложения
├── config/                     # Конфигурация приложения
│   └── app.go                  # Инициализация и запуск сервера
├── internal/                   # Внутренняя логика приложения
│   ├── delivery/               # Слой доставки (HTTP handlers)
│   │   └── http/v1/           # HTTP API версии 1
│   ├── service/                # Бизнес-логика
│   ├── repository/             # Слой доступа к данным
│   └── models/                 # Модели данных
├── pkg/                        # Переиспользуемые пакеты
│   └── database/               # Конфигурация БД
├── docs/                       # Swagger документация
├── tmp/                        # Временные файлы сборки
└── Dockerfile*                 # Docker конфигурации
```

## Слои архитектуры

### 1. Delivery Layer (Слой доставки)
**Расположение**: `internal/delivery/http/v1/`

- **Назначение**: Обработка HTTP запросов и ответов
- **Технологии**: Gin framework
- **Функции**:
  - Валидация входящих данных
  - Маршрутизация запросов
  - Обработка HTTP статусов
  - Делегирование бизнес-логики в service слой

### 2. Service Layer (Слой бизнес-логики)
**Расположение**: `internal/service/`

- **Назначение**: Содержит всю бизнес-логику приложения
- **Функции**:
  - Обработка бизнес-правил
  - Координация между различными репозиториями
  - Трансформация данных
  - Валидация бизнес-логики

### 3. Repository Layer (Слой доступа к данным)
**Расположение**: `internal/repository/`

- **Назначение**: Абстракция доступа к данным
- **Функции**:
  - Инкапсуляция SQL запросов
  - Маппинг данных БД в модели
  - Управление транзакциями
  - Кэширование (при необходимости)

### 4. Models Layer (Слой моделей)
**Расположение**: `internal/models/`

- **Назначение**: Определение структуры данных
- **Функции**:
  - Структуры для API запросов/ответов
  - Модели базы данных
  - DTO (Data Transfer Objects)

### 5. Infrastructure Layer (Инфраструктурный слой)
**Расположение**: `pkg/`

- **Назначение**: Внешние зависимости и утилиты
- **Функции**:
  - Подключение к базе данных
  - Конфигурация внешних сервисов
  - Общие утилиты

## Поток данных

```
HTTP Request → Handler → Service → Repository → Database
                ↓         ↓         ↓
HTTP Response ← Handler ← Service ← Repository ← Database
```

1. **HTTP Request** поступает в Handler
2. **Handler** валидирует данные и вызывает Service
3. **Service** обрабатывает бизнес-логику и вызывает Repository
4. **Repository** выполняет операции с базой данных
5. **Response** возвращается обратно по цепочке

## Конфигурация

### Переменные окружения

Приложение использует следующие переменные окружения:

```env
# База данных
DB_HOST=localhost
DB_PORT=5432
DB_USER=your_username
DB_PASS=your_password
DB_NAME=your_database
DB_SSLMODE=disable

# Сервер
SERVER_PORT=8080
GIN_MODE=release  # или debug для разработки
```

### Конфигурация Air (Hot Reload)

Файл `.air.toml` настроен для автоматической перезагрузки при изменениях:

- **Отслеживаемые файлы**: `.go`, `.tpl`, `.tmpl`, `.html`
- **Исключения**: `_test.go`, папки `tmp`, `vendor`, `testdata`
- **Задержка перезагрузки**: 1000ms
- **Логи ошибок**: `tmp/build-errors.log`

## Сборка и запуск

### Локальная разработка

```bash
# Установка зависимостей
go mod download

# Запуск с hot reload
air

# Или обычный запуск
go run cmd/app/main.go
```

### Docker

```bash
# Сборка production образа
docker build -f Dockerfile -t logger-api .

# Сборка development образа
docker build -f Dockerfile.dev -t logger-api:dev .

# Запуск контейнера
docker run -p 8080:8080 logger-api
```

### Генерация документации

```bash
# Генерация Swagger документации
make docs-gen
```

## API Endpoints

### Базовые маршруты

- `GET /api/v1/health` - Проверка состояния приложения
- `GET /api/v1/ping` - Простая проверка доступности

### Swagger документация

После генерации документации доступна по адресу:
- `GET /swagger/index.html` - Swagger UI интерфейс

## Структура проекта

### Основные директории

- **`cmd/`** - Точки входа приложения
- **`internal/`** - Внутренняя логика (не экспортируется)
- **`pkg/`** - Переиспользуемые пакеты
- **`docs/`** - Автогенерируемая документация
- **`tmp/`** - Временные файлы сборки

### Принципы организации

1. **Изоляция**: `internal/` пакеты не импортируются извне
2. **Переиспользование**: `pkg/` пакеты можно использовать в других проектах
3. **Четкое разделение**: Каждый слой имеет свою ответственность
4. **Зависимости внутрь**: Внешние слои зависят от внутренних

## Зависимости

### Основные

- **gin-gonic/gin** - HTTP веб-фреймворк
- **lib/pq** - PostgreSQL драйвер
- **joho/godotenv** - Загрузка переменных окружения
- **swaggo/swag** - Генерация Swagger документации

### Разработка

- **air-verse/air** - Hot reload для разработки

## Мониторинг и логирование

### Логирование

- Используется стандартный `log` пакет Go
- Gin middleware для HTTP логирования
- Логи ошибок сохраняются в `tmp/build-errors.log`

### Graceful Shutdown

Приложение поддерживает корректное завершение работы:

- Обработка сигналов `SIGINT` и `SIGTERM`
- Таймаут завершения: 5 секунд
- Корректное закрытие HTTP сервера

## Разработка

### Hot Reload

Для разработки используется Air:

```bash
# Запуск с автоматической перезагрузкой
air

# Конфигурация в .air.toml
```

### Тестирование

Структура для тестов:

- `*_test.go` файлы в соответствующих пакетах
- Тестовые файлы исключены из hot reload
- Отдельные тестовые репозитории и сервисы

### Код-стайл

- Следует стандартным Go конвенциям
- Использует `gofmt` для форматирования
- Комментарии для экспортируемых функций

## Производственное развертывание

### Docker

- Multi-stage сборка для оптимизации размера образа
- Использование Alpine Linux для минимального размера
- Настройка правильных прав доступа

### Переменные окружения

- Все конфигурации через переменные окружения
- Отдельные настройки для production/development
- Безопасное хранение секретов

### Мониторинг

- Health check endpoints
- Graceful shutdown
- Логирование ошибок
- Метрики производительности (при необходимости)

## Расширение функциональности

### Добавление нового API endpoint

1. Создать handler в `internal/delivery/http/v1/`
2. Добавить бизнес-логику в `internal/service/`
3. Реализовать доступ к данным в `internal/repository/`
4. Определить модели в `internal/models/`
5. Зарегистрировать маршрут в `InitRoutes`

### Добавление новой сущности

1. Создать модель в `internal/models/`
2. Реализовать repository интерфейс
3. Добавить service слой
4. Создать HTTP handlers
5. Обновить Swagger документацию

## Безопасность

- Валидация всех входящих данных
- Защита от SQL инъекций через prepared statements
- CORS настройки (при необходимости)
- Rate limiting (при необходимости)
- Аутентификация и авторизация (при необходимости)
